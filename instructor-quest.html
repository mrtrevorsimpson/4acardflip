<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Instructor Quest â€” Phase 3 (Contrast+WASD fix)</title>
<style>
  :root{ --bg:#0c0f17; --line:#243046; --text:#e5e7eb; --muted:#94a3b8; --accent:#38bdf8; }
  html,body{margin:0;height:100%;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;}
  header{display:flex;align-items:center;gap:.75rem;padding:.6rem .8rem;border-bottom:1px solid var(--line);background:linear-gradient(180deg,#121a2a,#0e1422);}
  header img.logo{height:32px} header h1{margin:0;font-size:1.05rem;font-weight:800} header .grow{flex:1}
  header .btn{background:#141c2c;border:1px solid #23304a;color:var(--text);padding:.4rem .6rem;border-radius:.5rem;cursor:pointer;font-weight:700}
  .wrap{display:grid;grid-template-rows:auto 1fr;height:100vh;}
  #game{position:relative;background:#000;min-height:480px;height:calc(100vh - 64px);}
  #view{display:block;width:100%;height:100%;background:#000} /* opaque base */
  .hud{position:absolute;left:0;right:0;top:0;display:flex;justify-content:space-between;gap:.5rem;padding:.4rem .6rem;pointer-events:none}
  .chip{pointer-events:auto;background:#0009;border:1px solid #334155;color:#e2e8f0;border-radius:.45rem;padding:.25rem .45rem;font-size:.85rem}
  #err{position:absolute;right:.6rem;top:.6rem;background:#7f1d1d;border:1px solid #ef4444;display:none}
  #dbg{position:absolute;left:.6rem;bottom:.6rem;background:#0b1220cc;border:1px solid #334155}
  #minimap{position:absolute;top:.6rem;right:.6rem;background:#0b1220cc;border:1px solid #334155;border-radius:.4rem;padding:.3rem}
  #minimap canvas{display:block}
  .controls{position:absolute;right:.6rem;bottom:.6rem;display:flex;gap:.5rem;flex-wrap:wrap}
  .controls .btn{pointer-events:auto;background:#0e1a30;border:1px solid #29476f}
  .modal{position:absolute;inset:0;display:none;place-items:center;background:rgba(0,0,0,.55);}
  .modal.show{display:grid;}
  .card{width:min(720px,92vw);max-height:86vh;overflow:auto;background:#0f172a;border:1px solid #2a3a5a;border-radius:12px;box-shadow:0 30px 80px rgba(0,0,0,.45);padding:14px}
  .choices{display:grid;gap:.5rem;margin-top:.6rem}
  .choices button{background:#121a2a;border:1px solid #2a3a5a;border-radius:10px;padding:.55rem .7rem;color:#e5e7eb;cursor:pointer;text-align:left}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <img class="logo" src="assiniboine.png" alt="Assiniboine" onerror="this.style.display='none'">
    <h1>Instructor Quest â€” Phase 3 (Contrast+WASD fix)</h1>
    <div class="grow"></div>
    <button class="btn" id="audioBtn">ðŸ”ˆ Audio</button>
  </header>

  <main id="game">
    <canvas id="view" width="960" height="540" tabindex="0" aria-label="Game canvas"></canvas>

    <div class="hud">
      <div class="chip">Score: <span id="score">0</span></div>
      <div class="chip">Badges: <span id="badgeCount">0</span></div>
      <div class="chip">Level <span id="level">1</span>/3</div>
      <div class="chip">Click canvas â†’ mouse-look â€¢ WASD/Arrows move â€¢ <strong>E</strong> interact</div>
    </div>

    <div id="err" class="chip"></div>
    <div id="dbg" class="chip">dbg</div>

    <div id="minimap"><canvas id="mapview" width="160" height="80"></canvas></div>

    <div class="controls">
      <button class="btn" id="rotateBtn">Rotate</button>
      <button class="btn" id="nudgeBtn">Nudge</button>
      <button class="btn" id="resetBtn">Reset</button>
    </div>

    <div class="modal" id="modal"><div class="card" id="card"></div></div>
  </main>
</div>

<script>
'use strict';
const errEl = document.getElementById('err');
window.addEventListener('error', e=>{ errEl.style.display='block'; errEl.textContent='JS error: '+(e.message||'(unknown)'); });

/* ---------- Canvas ---------- */
const canvas = document.getElementById('view');
const ctx = canvas.getContext('2d', { alpha:false });
let W=canvas.width, H=canvas.height;
const FOV=Math.PI/3;
let NUM_RAYS=120;                   // << fewer rays = wider columns
const MAX_DEPTH=18;

function resizeCanvas(){
  const game=document.getElementById('game');
  let w=game.clientWidth||960, h=game.clientHeight||540;
  if(!h||h<240) h=560;
  canvas.width=w; canvas.height=h; W=w; H=h;
  document.getElementById('dbg').textContent=`W:${W} H:${H} Rays:${NUM_RAYS} | x:${player.x.toFixed(2)} y:${player.y.toFixed(2)} a:${player.a.toFixed(2)}`;
}
addEventListener('load', resizeCanvas); addEventListener('resize', resizeCanvas);

/* ---------- World ---------- */
const state={level:1,score:0,badges:new Set()};
const scoreEl=document.getElementById('score'), badgeEl=document.getElementById('badgeCount'), levelEl=document.getElementById('level');

const levels=[{map:[
 "1111111111111111",
 "1..3....1....3.1",
 "1.111..11..11..1",
 "1..1....1......1",
 "1..1..3.1..3...1",
 "1..111..1..111.1",
 "1......E......31",
 "1111111111111111"]}];
let map=levels[0].map, cols=map[0].length, rows=map.length;
const player={x:2.5, y:2.5, a:0, fwd:0, strafe:0, rot:0, speed:2.2};

/* ---------- Helpers ---------- */
function tileAt(x,y){ const xi=Math.floor(x), yi=Math.floor(y); if(xi<0||yi<0||yi>=rows||xi>=cols) return 1; const ch=map[yi][xi]; return ch==='.'?0:(ch==='E'?2:(ch==='3'?3:1)); }
function castRay(angle){
  const sin=Math.sin(angle), cos=Math.cos(angle);
  let depth=0, hit=0, rx=player.x, ry=player.y;
  while(depth<MAX_DEPTH){ rx+=cos*0.02; ry+=sin*0.02; depth+=0.02; hit=tileAt(rx,ry); if(hit) break; }
  return {depth,hit};
}

/* ---------- Movement ---------- */
let lastTime=performance.now();
function move(dt){
  const step=player.speed*dt;
  const nx=player.x + (Math.cos(player.a)*player.fwd + Math.cos(player.a+Math.PI/2)*player.strafe)*step;
  const ny=player.y + (Math.sin(player.a)*player.fwd + Math.sin(player.a+Math.PI/2)*player.strafe)*step;
  if(tileAt(nx,player.y)===0) player.x=nx;
  if(tileAt(player.x,ny)===0) player.y=ny;
  player.a += player.rot*dt*2.2;
}

/* ---------- Render ---------- */
function drawWorld(){
  ctx.save();
  ctx.setTransform(1,0,0,1,0,0);
  ctx.globalAlpha=1; ctx.globalCompositeOperation='source-over';
  ctx.clearRect(0,0,W,H);
  // HIGH CONTRAST sky/floor so we can see it for sure
  ctx.fillStyle='#00ff77'; ctx.fillRect(0,0,W,H/2);     // bright green
  ctx.fillStyle='#ff0033'; ctx.fillRect(0,H/2,W,H/2);   // bright red

  let anyHit=false;
  const colWidth = Math.ceil(W/NUM_RAYS);               // << wider columns
  for(let r=0;r<NUM_RAYS;r++){
    const rayAngle=(player.a - FOV/2) + (r/NUM_RAYS)*FOV;
    const {depth,hit}=castRay(rayAngle);
    const dist = depth*Math.cos(rayAngle - player.a);
    const h = Math.min(H, (H/(dist+0.0001)));
    const shade = Math.max(0,1 - dist/MAX_DEPTH);
    const base = 50 + Math.floor(205*shade);
    ctx.fillStyle = `rgb(${base},${base},${base})`;
    const x = r*colWidth;
    ctx.fillRect(x,(H-h)/2,colWidth,h);
    if(hit) anyHit=true;
    if(hit===2){ ctx.fillStyle='#38bdf8'; ctx.fillRect(x,(H-h)/2,colWidth,2); ctx.fillRect(x,(H+h)/2-2,colWidth,2); }
    if(hit===3){ ctx.fillStyle='#ffea00'; ctx.fillRect(x,(H-h)/2,colWidth,2); }
  }

  ctx.fillStyle='#ffffff'; ctx.font='bold 16px system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial';
  ctx.fillText(anyHit?'renderingâ€¦':'NO HITS â€” check map', 12, 24);
  ctx.fillRect(W/2-1, H/2-8, 2, 16); ctx.fillRect(W/2-8, H/2-1, 16, 2);
  ctx.restore();
}

/* ---------- Minimap ---------- */
const mapCanvas=document.getElementById('mapview'); const mctx=mapCanvas.getContext('2d');
function drawMinimap(){
  const sx=mapCanvas.width/cols, sy=mapCanvas.height/rows;
  mctx.clearRect(0,0,mapCanvas.width,mapCanvas.height);
  for(let y=0;y<rows;y++) for(let x=0;x<cols;x++){
    const ch=map[y][x];
    mctx.fillStyle = ch==='1' ? '#334155' : ch==='E' ? '#38bdf8' : ch==='3' ? '#ef4444' : '#0b1220';
    mctx.fillRect(x*sx, y*sy, sx-1, sy-1);
  }
  mctx.fillStyle='#22c55e'; mctx.beginPath(); mctx.arc(player.x*sx, player.y*sy, 2.5, 0, Math.PI*2); mctx.fill();
  mctx.strokeStyle='#22c55e'; mctx.beginPath(); mctx.moveTo(player.x*sx, player.y*sy); mctx.lineTo((player.x+Math.cos(player.a))*sx,(player.y+Math.sin(player.a))*sy); mctx.stroke();
}

/* ---------- Loop ---------- */
function loop(t){ const dt=Math.min(0.05,(t-lastTime)/1000); lastTime=t; move(dt); drawWorld(); drawMinimap(); document.getElementById('dbg').textContent=`W:${W} H:${H} Rays:${NUM_RAYS} | x:${player.x.toFixed(2)} y:${player.y.toFixed(2)} a:${player.a.toFixed(2)}`; requestAnimationFrame(loop); }
requestAnimationFrame(loop);

/* ---------- Input: accept code **and** key (lowercased) ---------- */
const keys={};
function setKey(e,down){
  const code=e.code; const k=(e.key||'').toLowerCase();
  if(['w','a','s','d','arrowup','arrowdown','arrowleft','arrowright','e'].includes(k)
     || ['KeyW','KeyA','KeyS','KeyD','ArrowUp','ArrowDown','ArrowLeft','ArrowRight'].includes(code)){
    e.preventDefault();
  }
  if(code) keys[code]=down;
  if(k) keys[k]=down;
  updateIntent();
}
function updateIntent(){
  const up   = (keys['KeyW']||keys['w']||keys['ArrowUp']) ? 1:0;
  const down = (keys['KeyS']||keys['s']||keys['ArrowDown']) ? 1:0;
  const left = (keys['KeyA']||keys['a']||keys['ArrowLeft']) ? 1:0;
  const right= (keys['KeyD']||keys['d']||keys['ArrowRight']) ? 1:0;
  player.fwd = up - down;
  player.strafe = right - left;
  player.rot = 0; // arrows handled in strafe; mouse handles rotate
  if (keys['KeyE']||keys['e']) tryInteract();
}
document.addEventListener('keydown', e=>setKey(e,true), {passive:false});
document.addEventListener('keyup',   e=>setKey(e,false), {passive:false});
canvas.addEventListener('click',()=>{ canvas.focus(); canvas.requestPointerLock?.(); });

/* ---------- Buttons ---------- */
let autoRotate=false;
document.getElementById('rotateBtn').onclick=()=>{ autoRotate=!autoRotate; document.getElementById('rotateBtn').textContent=autoRotate?'Stop Rotate':'Rotate'; };
document.getElementById('nudgeBtn').onclick=()=>{ player.fwd=1; setTimeout(()=>player.fwd=0, 250); };
document.getElementById('resetBtn').onclick=()=>{ player.x=2.5; player.y=2.5; player.a=0; };

/* ---------- Encounters (kept minimal for test) ---------- */
const modal=document.getElementById('modal'), card=document.getElementById('card');
function show(html){ card.innerHTML=html; modal.classList.add('show'); }
function hide(){ modal.classList.remove('show'); }
function tryInteract(){
  const ax=player.x+Math.cos(player.a)*0.5, ay=player.y+Math.sin(player.a)*0.5;
  const hit = tileAt(ax,ay);
  if (hit===3){ show(`<h2>Encounter!</h2><p>Test modal. Press Close.</p><div class="choices"><button onclick="document.querySelector('.modal').classList.remove('show')">Close</button></div>`); }
}

/* ---------- Utils ---------- */
</script>
</body>
</html>
