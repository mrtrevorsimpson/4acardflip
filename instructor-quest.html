<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Instructor Quest â€” Phase 3 (Minimap+Debug)</title>
<style>
  :root{ --bg:#0c0f17; --line:#243046; --text:#e5e7eb; --muted:#94a3b8; --accent:#38bdf8; }
  html,body{margin:0;height:100%;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;}

  /* Header */
  header{display:flex;align-items:center;gap:.75rem;padding:.6rem .8rem;border-bottom:1px solid var(--line);
    background:linear-gradient(180deg,#121a2a,#0e1422);}
  header img.logo{height:32px}
  header h1{margin:0;font-size:1.05rem;font-weight:800}
  header .grow{flex:1}
  header .btn{background:#141c2c;border:1px solid #23304a;color:var(--text);
    padding:.4rem .6rem;border-radius:.5rem;cursor:pointer;font-weight:700;letter-spacing:.3px}
  header .btn:hover{border-color:#3a4e79}

  /* Layout */
  .wrap{display:grid;grid-template-rows:auto 1fr;height:100vh;}
  #game{position:relative;background:#000;min-height:480px;height:calc(100vh - 64px);}
  #view{display:block;width:100%;height:100%;}

  /* HUD + debug */
  .hud{position:absolute;left:0;right:0;top:0;display:flex;justify-content:space-between;gap:.5rem;padding:.4rem .6rem;pointer-events:none}
  .chip{pointer-events:auto;background:#0009;border:1px solid #334155;color:#e2e8f0;border-radius:.45rem;padding:.25rem .45rem;font-size:.85rem}
  #err{position:absolute;right:.6rem;top:.6rem;background:#7f1d1d;border:1px solid #ef4444;display:none}
  #dbg{position:absolute;left:.6rem;bottom:.6rem;background:#0b1220cc;border:1px solid #334155}

  /* Floating controls */
  .controls{position:absolute;right:.6rem;bottom:.6rem;display:flex;gap:.5rem;flex-wrap:wrap}
  .controls .btn{pointer-events:auto;background:#0e1a30;border:1px solid #29476f}

  /* Minimap */
  #minimap{position:absolute;top:.6rem;right:.6rem;background:#0b1220cc;border:1px solid #334155;border-radius:.4rem;padding:.3rem}
  #minimap canvas{display:block}

  /* Modal */
  .modal{position:absolute;inset:0;display:none;place-items:center;background:rgba(0,0,0,.55);}
  .modal.show{display:grid;}
  .card{width:min(720px,92vw);max-height:86vh;overflow:auto;background:linear-gradient(180deg,#0f172a,#0b1220);
    border:1px solid #2a3a5a;border-radius:12px;box-shadow:0 30px 80px rgba(0,0,0,.45);padding:14px}
  .card h2{margin:.1rem 0 .4rem;font-size:1.2rem}
  .card p{margin:.35rem 0;color:var(--muted)}
  .choices{display:grid;gap:.5rem;margin-top:.6rem}
  .choices button{background:#121a2a;border:1px solid #2a3a5a;border-radius:10px;padding:.55rem .7rem;color:#e5e7eb;cursor:pointer;text-align:left}
  .choices button:hover{border-color:#4663a0}
  .feedback{margin-top:.6rem;padding:.5rem .6rem;border-radius:10px;background:#0c1220;color:#cbd5e1;border:1px solid #243b69}
  .badge-row{display:flex;gap:.4rem;flex-wrap:wrap;margin-top:.6rem}
  .badge{background:#13223f;border:1px solid #2b4b8a;color:#dbeafe;padding:.25rem .5rem;border-radius:.5rem;font-size:.8rem}
  .poster{max-width:220px;border-radius:10px;border:1px solid #2a3a5a;margin-right:12px}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <img class="logo" src="assiniboine.png" alt="Assiniboine" onerror="this.style.display='none'">
    <h1>Instructor Quest â€” Phase 3 (Minimap)</h1>
    <div class="grow"></div>
    <button class="btn" id="audioBtn">ðŸ”ˆ Audio</button>
  </header>

  <main id="game" aria-label="Wolf3D-like hallway">
    <canvas id="view" width="960" height="540"></canvas>

    <div class="hud">
      <div class="chip">Score: <span id="score">0</span></div>
      <div class="chip">Badges: <span id="badgeCount">0</span></div>
      <div class="chip">Level <span id="level">1</span>/3</div>
      <div class="chip">Click canvas â†’ mouse-look â€¢ WASD move â€¢ <strong>E</strong> interact</div>
    </div>

    <div id="err" class="chip"></div>
    <div id="dbg" class="chip">dbg</div>

    <div id="minimap"><canvas id="mapview" width="160" height="80"></canvas></div>

    <div class="controls">
      <button class="btn" id="rotateBtn">Rotate</button>
      <button class="btn" id="nudgeBtn">Nudge Forward</button>
      <button class="btn" id="resetBtn">Reset</button>
    </div>

    <div class="modal" id="modal"><div class="card" id="card"></div></div>
  </main>
</div>

<script>
'use strict';

/* ---------- Error reporter ---------- */
(function(){
  const err = document.getElementById('err');
  window.addEventListener('error', e=>{
    err.style.display='block';
    err.textContent = 'JS error: ' + (e.message || '(unknown)');
  });
})();

/* ---------- Canvas sizing ---------- */
const canvas = document.getElementById('view');
const ctx = canvas.getContext('2d', { alpha: false });

let W = canvas.width, H = canvas.height;
const FOV = Math.PI/3;
let NUM_RAYS = Math.floor(W/2);
const MAX_DEPTH = 18;

function resizeCanvas(){
  const game = document.getElementById('game');
  let w = game.clientWidth || 960;
  let h = game.clientHeight || 540;
  if (!h || h < 240) h = 560;
  canvas.width = w; canvas.height = h;
  W = w; H = h; NUM_RAYS = Math.floor(W/2);
  showDbg();
}
function showDbg(){ document.getElementById('dbg').textContent = `W:${W} H:${H} Rays:${NUM_RAYS}  |  x:${player.x.toFixed(2)} y:${player.y.toFixed(2)} a:${player.a.toFixed(2)}`; }
addEventListener('load', resizeCanvas);
addEventListener('resize', resizeCanvas);

/* ---------- World data ---------- */
const state = { level:1, score:0, badges:new Set(), audioOn:false };
const scoreEl = document.getElementById('score');
const badgeEl = document.getElementById('badgeCount');
const levelEl = document.getElementById('level');

const levels = [
  {map:[
    "1111111111111111",
    "1..3....1....3.1",
    "1.111..11..11..1",
    "1..1....1......1",
    "1..1..3.1..3...1",
    "1..111..1..111.1",
    "1......E......31",
    "1111111111111111"
  ]},
  {map:[
    "1111111111111111",
    "1..3...11....3.1",
    "1.111..11..11..1",
    "1..1....1.....E1",
    "1..1..3.1..3...1",
    "1..111..1..111.1",
    "1.3...........31",
    "1111111111111111"
  ]},
  {map:[
    "1111111111111111",
    "1..3...11....3.1",
    "1.111..11..11..1",
    "1..1....1......1",
    "1..1..3.1..3...1",
    "1..111..1..111.1",
    "1...3....E.....1",
    "1111111111111111"
  ]}
];
let map = levels[0].map, cols = map[0].length, rows = map.length;

const player = { x:2.5, y:2.5, a:0, fwd:0, strafe:0, rot:0, speed:2.2 };

/* ---------- Helpers ---------- */
function tileAt(x,y){
  const xi=Math.floor(x), yi=Math.floor(y);
  if (xi<0||yi<0||yi>=rows||xi>=cols) return 1;
  const ch=map[yi][xi];
  return ch==='.'?0:(ch==='E'?2:(ch==='3'?3:1));
}
function castRay(angle){
  const sin=Math.sin(angle), cos=Math.cos(angle);
  let depth=0, hit=0, rx=player.x, ry=player.y;
  while(depth<MAX_DEPTH){
    rx+=cos*0.02; ry+=sin*0.02; depth+=0.02;
    hit=tileAt(rx,ry); if(hit) break;
  }
  return {depth,hit};
}

/* ---------- Movement ---------- */
let lastTime = performance.now();
function move(dt){
  const step = player.speed*dt;
  const nx = player.x + (Math.cos(player.a)*player.fwd + Math.cos(player.a+Math.PI/2)*player.strafe)*step;
  const ny = player.y + (Math.sin(player.a)*player.fwd + Math.sin(player.a+Math.PI/2)*player.strafe)*step;
  if (tileAt(nx,player.y)===0) player.x=nx;
  if (tileAt(player.x,ny)===0) player.y=ny;
  player.a += player.rot*dt*2.2;
}

/* ---------- Render ---------- */
function drawWorld(){
  // sky/floor
  ctx.fillStyle='#0b1020'; ctx.fillRect(0,0,W,H/2);
  ctx.fillStyle='#0a0d17'; ctx.fillRect(0,H/2,W,H/2);

  let anyHit=false;
  for(let r=0;r<NUM_RAYS;r++){
    const rayAngle=(player.a - FOV/2) + (r/NUM_RAYS)*FOV;
    const {depth,hit} = castRay(rayAngle);
    const dist = depth*Math.cos(rayAngle - player.a);
    const h = Math.min(H, (H/(dist+0.0001)));
    const shade = Math.max(0, 1 - dist/MAX_DEPTH);
    const col = `rgba(${Math.floor(60+120*shade)},${Math.floor(70+90*shade)},${Math.floor(110+120*shade)},1)`;
    ctx.fillStyle = col;
    const x = Math.floor((r/NUM_RAYS)*W);
    ctx.fillRect(x,(H-h)/2,Math.ceil(W/NUM_RAYS)+1,h);

    if(hit){ anyHit=true; }
    if(hit===2){ ctx.fillStyle=varAccent(); ctx.fillRect(x,(H-h)/2,Math.ceil(W/NUM_RAYS)+1,2); ctx.fillRect(x,(H+h)/2-2,Math.ceil(W/NUM_RAYS)+1,2); }
    if(hit===3){ ctx.fillStyle='rgba(239,68,68,.85)'; ctx.fillRect(x,(H-h)/2,Math.ceil(W/NUM_RAYS)+1,1); }
  }

  if(!anyHit){
    ctx.fillStyle='#ef4444'; ctx.font='bold 18px system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial';
    ctx.fillText('NO HITS â€” rays did not find walls. (Map/scale?)', 12, 24);
  }

  // live label
  ctx.fillStyle='rgba(255,255,255,.9)';
  ctx.font='bold 16px system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial';
  ctx.fillText('PHASE 3 (minimap build)', 12, 46);
}

/* ---------- Minimap ---------- */
const mapCanvas = document.getElementById('mapview');
const mctx = mapCanvas.getContext('2d');
function drawMinimap(){
  const scaleX = mapCanvas.width / cols;
  const scaleY = mapCanvas.height / rows;
  mctx.clearRect(0,0,mapCanvas.width,mapCanvas.height);
  for(let y=0;y<rows;y++){
    for(let x=0;x<cols;x++){
      const ch = map[y][x];
      if (ch==='1'){ mctx.fillStyle='#334155'; }
      else if(ch==='E'){ mctx.fillStyle='#38bdf8'; }
      else if(ch==='3'){ mctx.fillStyle='#ef4444'; }
      else { mctx.fillStyle='#0b1220'; }
      mctx.fillRect(x*scaleX, y*scaleY, scaleX-1, scaleY-1);
    }
  }
  // player
  mctx.fillStyle='#22c55e';
  mctx.beginPath();
  mctx.arc(player.x*scaleX, player.y*scaleY, 2.5, 0, Math.PI*2);
  mctx.fill();
  // FOV line
  mctx.strokeStyle='#22c55e';
  mctx.beginPath();
  mctx.moveTo(player.x*scaleX, player.y*scaleY);
  mctx.lineTo((player.x+Math.cos(player.a))*scaleX, (player.y+Math.sin(player.a))*scaleY);
  mctx.stroke();
}

/* ---------- Game loop ---------- */
function loop(t){
  try{
    const dt=Math.min(0.05,(t-lastTime)/1000); lastTime=t;
    move(dt); drawWorld(); drawMinimap(); showDbg();
    requestAnimationFrame(loop);
  }catch(e){
    const err=document.getElementById('err');
    err.style.display='block';
    err.textContent='Loop error: '+e.message;
  }
}
requestAnimationFrame(loop);

/* ---------- Input ---------- */
const keys={};
function updateIntent(){
  player.fwd   = (keys['KeyW']||keys['ArrowUp']?1:0) + (keys['KeyS']||keys['ArrowDown']?-1:0);
  player.strafe= (keys['KeyD']?1:0) + (keys['KeyA']?-1:0);
  player.rot   = (keys['ArrowRight']?1:0) + (keys['ArrowLeft']?-1:0);
  if (keys['KeyE']) tryInteract();
}
addEventListener('keydown',e=>{
  if(['KeyW','KeyS','ArrowUp','ArrowDown','KeyA','KeyD','ArrowLeft','ArrowRight','KeyE'].includes(e.code)) e.preventDefault();
  keys[e.code]=true; updateIntent();
});
addEventListener('keyup',e=>{ keys[e.code]=false; updateIntent(); });
canvas.addEventListener('mousemove',e=>{
  if (document.pointerLockElement===canvas) player.a += e.movementX*0.0025;
});
canvas.addEventListener('click',()=>canvas.requestPointerLock());

/* ---------- Buttons (prove render/move even if keys blocked) ---------- */
let autoRotate=false;
document.getElementById('rotateBtn').onclick=()=>{ autoRotate=!autoRotate; document.getElementById('rotateBtn').textContent = autoRotate? 'Stop Rotate':'Rotate'; };
document.getElementById('nudgeBtn').onclick=()=>{ player.fwd=1; setTimeout(()=>{ player.fwd=0; }, 250); };
document.getElementById('resetBtn').onclick=()=>{ player.x=2.5; player.y=2.5; player.a=0; };

(function spin(){
  if(autoRotate) player.a += 0.02;
  requestAnimationFrame(spin);
})();

/* ---------- Modal helpers ---------- */
const modal=document.getElementById('modal'), card=document.getElementById('card');
function show(html){ card.innerHTML=html; modal.classList.add('show'); }
function hide(){ modal.classList.remove('show'); }

/* ---------- Encounters (with reflection) ---------- */
const ENCOUNTERS = [
  {
    id:"hall-001",
    title:"Late Submission Dilemma",
    scenario:"A student is overwhelmed and asks for an extension on tonightâ€™s lab report.",
    choices:[
      "Decline to keep policy consistent.",
      "Offer a 24-hour grace period with a plan.",
      "Give a full week with no conditions."
    ],
    correct_index:1,
    theory_tags:["UDL","Formative Assessment","Trauma-Informed"],
    feedback:[
      "Consistency matters, but structured flexibility builds equity. Try a supportive option.",
      "Nice. You preserved expectations while scaffolding autonomyâ€”very UDL.",
      "Caring impulse! Add structure so learning stays on track."
    ]
  },
  {
    id:"hall-002",
    title:"Phones in Class",
    scenario:"Two students are on their phones during a demonstration.",
    choices:[
      "Pause and set a collaborative norm for focus.",
      "Confiscate the phones immediately.",
      "Ignore it and continue."
    ],
    correct_index:0,
    theory_tags:["Constructivism","Classroom Management","4As: Activate"],
    feedback:[
      "Yesâ€”co-creating norms builds buy-in and attention.",
      "Enforcement alone may spark resistanceâ€”invite ownership first.",
      "Silence can signal acceptance. Try a quick norms reset."
    ]
  }
];

function randomEncounter(){ return ENCOUNTERS[Math.floor(Math.random()*ENCOUNTERS.length)]; }

function tryInteract(){
  const ax = player.x + Math.cos(player.a)*0.5;
  const ay = player.y + Math.sin(player.a)*0.5;
  const hit = tileAt(ax,ay);
  if (hit===3) openEncounter();
  if (hit===2) nextLevel();
}

function openEncounter(){
  const q = randomEncounter();
  // clear triggered tile so it won't reopen instantly
  const tx=Math.floor(player.x + Math.cos(player.a)*0.5);
  const ty=Math.floor(player.y + Math.sin(player.a)*0.5);
  const row = map[ty].split(""); row[tx]='.'; map[ty]=row.join("");

  function renderProblem(feedback){
    show(`
      <h2>${q.title}</h2>
      <p>${q.scenario}</p>
      <div class="choices">
        ${q.choices.map((c,i)=>`<button data-i="${i}">${c}</button>`).join('')}
      </div>
      ${feedback?`<div class="feedback">${feedback}</div>`:''}
    `);
    card.querySelectorAll('button[data-i]').forEach(b=>{
      b.onclick=()=>{
        const i=+b.dataset.i;
        if(i===q.correct_index){
          state.score+=100; scoreEl.textContent=state.score;
          renderTheory();
        }else{
          state.score=Math.max(0,state.score-10); scoreEl.textContent=state.score;
          renderProblem(q.feedback[i]||"Good thinkingâ€”consider learner needs and try again.");
        }
      };
    });
  }

  function renderTheory(feedback){
    const allTags = Array.from(new Set(q.theory_tags.concat(["Summative Assessment"])));
    show(`
      <div style="display:flex;gap:12px;align-items:flex-start">
        <img src="fdcdoubledragon.png" alt="" class="poster" onerror="this.style.display='none'">
        <div style="flex:1">
          <h2>Reflection: Which theory best aligns?</h2>
          <p>Pick the theory or framework that best explains your action.</p>
          <div class="choices">
            ${shuffle(allTags).map(t=>`<button data-t="${t}">${t}</button>`).join('')}
          </div>
          ${feedback?`<div class="feedback">${feedback}</div>`:''}
          <div class="badge-row" id="badgeRow"></div>
        </div>
      </div>
    `);
    const badgeRow = document.getElementById('badgeRow');
    function repaintBadges(){
      badgeRow.innerHTML = [...state.badges].map(b=>`<span class="badge">${b}</span>`).join('');
    }
    repaintBadges();

    card.querySelectorAll('button[data-t]').forEach(b=>{
      b.onclick=()=>{
        const t=b.dataset.t;
        if(q.theory_tags.includes(t)){
          state.badges.add(t);
          badgeEl.textContent = state.badges.size;
          state.score+=50; scoreEl.textContent=state.score;
          repaintBadges();
          hide();
        }else{
          state.score=Math.max(0,state.score-10); scoreEl.textContent=state.score;
          renderTheory(`Nice! The stronger match is likely one of: <strong>${q.theory_tags.join(', ')}</strong>. Try again!`);
        }
      };
    });
  }

  renderProblem();
}

function nextLevel(){
  if (state.level<3){
    state.level++; levelEl.textContent=state.level;
    map = levels[state.level-1].map; rows=map.length; cols=map[0].length;
    player.x=2.5; player.y=2.5; player.a=0;
    show(`<h2>Level ${state.level}</h2><p>Head for the exit and support more students on the way.</p>
          <div class="choices"><button onclick="document.querySelector('.modal').classList.remove('show')">Start</button></div>`);
  } else {
    const list=[...state.badges].map(b=>`<span class="badge">${b}</span>`).join('');
    show(`<h2>Classroom Reached! âœ…</h2>
          <p>Score: <strong>${state.score}</strong></p>
          <div>Badges earned: <div class="badge-row">${list||"<em>None (yet)</em>"}</div></div>
          <div class="choices"><button onclick="location.reload()">Restart</button>
          <button onclick="document.querySelector('.modal').classList.remove('show')">Close</button></div>`);
  }
}

/* ---------- Audio toggle (stub) ---------- */
document.getElementById('audioBtn').onclick=()=> {
  const b=document.getElementById('audioBtn');
  state.audioOn = !state.audioOn;
  b.textContent = state.audioOn ? 'ðŸ”Š Audio' : 'ðŸ”ˆ Audio';
};

/* ---------- Utils ---------- */
function varAccent(){ return getComputedStyle(document.documentElement).getPropertyValue('--accent').trim() || '#38bdf8'; }
function shuffle(a){ const arr=a.slice(); for(let i=arr.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]];} return arr; }
</script>
</body>
</html>
