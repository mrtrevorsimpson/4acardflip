<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Instructor Quest â€” Wolf3D-style Teaching Game</title>
<style>
  :root{
    --bg:#0c0f17; --line:#243046; --text:#e5e7eb; --muted:#94a3b8;
  }
  html,body{margin:0;height:100%;background:var(--bg);color:var(--text);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;}
  /* header */
  header{display:flex;align-items:center;gap:.75rem;padding:.6rem .8rem;
    border-bottom:1px solid var(--line);background:linear-gradient(180deg,#121a2a,#0e1422);}
  header img.logo{height:32px}
  header h1{margin:0;font-size:1.05rem;font-weight:800}
  header .grow{flex:1}
  header .btn{background:#141c2c;border:1px solid #23304a;color:var(--text);
    padding:.4rem .6rem;border-radius:.5rem;cursor:pointer;font-weight:700;letter-spacing:.3px}

  /* layout â€” CRITICAL: give the game area real height */
  .wrap{display:grid;grid-template-rows:auto 1fr;height:100vh;}
  #game{position:relative;background:#000;height:calc(100vh - 56px);} /* ~header height */
  #view{display:block;width:100%;height:100%;}

  /* HUD */
  .hud{position:absolute;left:0;right:0;top:0;display:flex;justify-content:space-between;
    padding:.4rem .6rem;pointer-events:none}
  .chip{pointer-events:auto;background:#0009;border:1px solid #334155;color:#e2e8f0;
    border-radius:.45rem;padding:.25rem .45rem;font-size:.85rem}

  /* Modal */
  .modal{position:absolute;inset:0;display:none;place-items:center;background:rgba(0,0,0,.55);}
  .modal.show{display:grid;}
  .card{width:min(720px,92vw);max-height:86vh;overflow:auto;background:#0f172a;
    border:1px solid #2a3a5a;border-radius:12px;padding:14px}
  .choices{display:grid;gap:.5rem;margin-top:.6rem}
  .choices button{background:#121a2a;border:1px solid #2a3a5a;border-radius:10px;
    padding:.55rem .7rem;color:#e5e7eb;cursor:pointer;text-align:left}
  .feedback{margin-top:.6rem;padding:.5rem .6rem;border-radius:10px;background:#0c1220;color:#cbd5e1;border:1px solid #243b69}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <img class="logo" src="assiniboinelogo.PNG" alt="Assiniboine" onerror="this.style.display='none'">
    <h1>Instructor Quest</h1>
    <div class="grow"></div>
    <button class="btn" id="audioBtn">ðŸ”ˆ Audio</button>
  </header>

  <main id="game" aria-label="Wolf3D-like hallway">
    <canvas id="view" width="960" height="540"></canvas>

    <div class="hud">
      <div class="chip">Score: <span id="score">0</span></div>
      <div class="chip">Badges: <span id="badgeCount">0</span></div>
      <div class="chip">Level <span id="level">1</span>/3</div>
      <div class="chip">WASD + Mouse | E to interact</div>
    </div>

    <div class="modal" id="modal"><div class="card" id="card"></div></div>
  </main>
</div>

<script>
/* ---------- Canvas + sizing (no duplicate vars) ---------- */
const canvas = document.getElementById('view');
const ctx = canvas.getContext('2d');
let W = canvas.width;
let H = canvas.height;
const FOV = Math.PI/3;
let NUM_RAYS = Math.floor(W/2);
const MAX_DEPTH = 18;

function resizeCanvas(){
  const game = document.getElementById('game');
  const w = game.clientWidth;
  const h = game.clientHeight;
  // set the real drawing size
  canvas.width = w;
  canvas.height = h;
  W = w; H = h;
  NUM_RAYS = Math.floor(W/2);
}
window.addEventListener('load', resizeCanvas);
window.addEventListener('resize', resizeCanvas);

/* ---------- Minimal raycaster ---------- */
const state = { level:1, score:0, badges:new Set(), audioOn:false };
const levels = [
  {map:["1111111111111111","1..3....1....3.1","1.111..11..11..1","1..1....1......1","1..1..3.1..3...1","1..111..1..111.1","1......E......31","1111111111111111"]},
  {map:["1111111111111111","1..3...11....3.1","1.111..11..11..1","1..1....1.....E1","1..1..3.1..3...1","1..111..1..111.1","1.3...........31","1111111111111111"]},
  {map:["1111111111111111","1..3...11....3.1","1.111..11..11..1","1..1....1......1","1..1..3.1..3...1","1..111..1..111.1","1...3....E.....1","1111111111111111"]}
];
let map = levels[0].map, cols = map[0].length, rows = map.length;
const player = { x:2.5, y:2.5, a:0, fwd:0, strafe:0, rot:0, speed:2.2 };
let lastTime = performance.now();

function tileAt(x,y){
  const xi=Math.floor(x), yi=Math.floor(y);
  if(xi<0||yi<0||yi>=rows||xi>=cols) return 1;
  const ch = map[yi][xi];
  return ch==='.'?0:(ch==='E'?2:(ch==='3'?3:1));
}
function castRay(angle){
  let sin=Math.sin(angle), cos=Math.cos(angle), depth=0, hit=0;
  let rx=player.x, ry=player.y;
  while(depth<MAX_DEPTH){
    rx+=cos*0.02; ry+=sin*0.02; depth+=0.02;
    hit=tileAt(rx,ry); if(hit===1||hit===2||hit===3) break;
  }
  return {depth,hit};
}
function move(dt){
  const step=player.speed*dt;
  const nx=player.x + (Math.cos(player.a)*player.fwd + Math.cos(player.a+Math.PI/2)*player.strafe)*step;
  const ny=player.y + (Math.sin(player.a)*player.fwd + Math.sin(player.a+Math.PI/2)*player.strafe)*step;
  if(tileAt(nx,player.y)===0) player.x=nx;
  if(tileAt(player.x,ny)===0) player.y=ny;
  player.a += player.rot*dt*2.2;
}
function draw(){
  ctx.fillStyle='#0b1020'; ctx.fillRect(0,0,W,H/2);
  ctx.fillStyle='#0a0d17'; ctx.fillRect(0,H/2,W,H/2);
  for(let r=0;r<NUM_RAYS;r++){
    const rayAngle=(player.a - FOV/2) + (r/NUM_RAYS)*FOV;
    const {depth,hit}=castRay(rayAngle);
    const dist=depth*Math.cos(rayAngle - player.a);
    const h=Math.min(H,(H/(dist+0.0001)));
    const shade=Math.max(0,1 - dist/MAX_DEPTH);
    const col=`rgba(${Math.floor(60+120*shade)},${Math.floor(70+90*shade)},${Math.floor(110+120*shade)},1)`;
    ctx.fillStyle=col;
    const x=Math.floor((r/NUM_RAYS)*W);
    ctx.fillRect(x,(H-h)/2,Math.ceil(W/NUM_RAYS)+1,h);
    if(hit===2){ ctx.fillStyle='#38bdf8'; ctx.fillRect(x,(H-h)/2,Math.ceil(W/NUM_RAYS)+1,2); ctx.fillRect(x,(H+h)/2-2,Math.ceil(W/NUM_RAYS)+1,2); }
  }
}
function loop(t){
  const dt=Math.min(0.05,(t-lastTime)/1000); lastTime=t;
  move(dt); draw(); requestAnimationFrame(loop);
}
requestAnimationFrame(loop);

/* ---------- Input ---------- */
const keys={};
function updateIntent(){
  player.fwd=(keys['KeyW']||keys['ArrowUp']?1:0) + (keys['KeyS']||keys['ArrowDown']?-1:0);
  player.strafe=(keys['KeyD']?1:0) + (keys['KeyA']?-1:0);
  player.rot=(keys['ArrowRight']?1:0) + (keys['ArrowLeft']?-1:0);
  if(keys['KeyE']) tryInteract();
}
addEventListener('keydown',e=>{
  if(['KeyW','KeyS','ArrowUp','ArrowDown','KeyA','KeyD','ArrowLeft','ArrowRight','KeyE'].includes(e.code)) e.preventDefault();
  keys[e.code]=true; updateIntent();
});
addEventListener('keyup',e=>{ keys[e.code]=false; updateIntent(); });
canvas.addEventListener('mousemove',e=>{
  if (document.pointerLockElement===canvas) player.a += e.movementX*0.0025;
});
canvas.addEventListener('click',()=>canvas.requestPointerLock());

/* ---------- Encounters (kept minimal so we know it runs) ---------- */
const modal=document.getElementById('modal'), card=document.getElementById('card');
const scoreEl=document.getElementById('score'), badgeEl=document.getElementById('badgeCount'), levelEl=document.getElementById('level');

const ENCOUNTERS=[{
  id:"hall-001",
  title:"Late Submission Dilemma",
  scenario:"A student is overwhelmed and asks for an extension on tonightâ€™s lab report.",
  choices:["Decline to keep policy consistent.","Offer a 24-hour grace period with a plan.","Give a full week with no conditions."],
  correct_index:1,
  theory_tags:["UDL","Formative Assessment","Trauma-Informed"],
  feedback:[
    "Consistency matters, but structured flexibility builds equity. Try a supportive option.",
    "Nice. You preserved expectations while scaffolding autonomyâ€”very UDL.",
    "Caring impulse! Add structure so learning stays on track."
  ]
}];

function show(html){ card.innerHTML=html; modal.classList.add('show'); }
function hide(){ modal.classList.remove('show'); }
function tileAhead(){
  const ax = player.x + Math.cos(player.a)*0.5;
  const ay = player.y + Math.sin(player.a)*0.5;
  return tileAt(ax,ay);
}
function tryInteract(){
  const hit=tileAhead();
  if(hit===3){ openEncounter(); }
  if(hit===2){ nextLevel(); }
}
function openEncounter(){
  const q = ENCOUNTERS[0];
  function renderProblem(feedback){
    show(`<h2>${q.title}</h2><p>${q.scenario}</p>
      <div class="choices">
        ${q.choices.map((c,i)=>`<button data-i="${i}">${c}</button>`).join('')}
      </div>${feedback?`<div class="feedback">${feedback}</div>`:''}`);
    card.querySelectorAll('button[data-i]').forEach(b=>{
      b.onclick=()=>{ const i=+b.dataset.i;
        if(i===q.correct_index){ state.score+=100; scoreEl.textContent=state.score; hide(); }
        else{ state.score=Math.max(0,state.score-10); scoreEl.textContent=state.score;
              renderProblem(q.feedback[i]||"Good thinkingâ€”consider needs and try again."); }
      };
    });
  }
  renderProblem();
}
function nextLevel(){
  if(state.level<3){ state.level++; levelEl.textContent=state.level;
    map=levels[state.level-1].map; rows=map.length; cols=map[0].length;
    player.x=2.5; player.y=2.5; player.a=0;
  } else {
    show(`<h2>Classroom Reached! âœ…</h2><p>Score: <strong>${state.score}</strong></p>
          <div class="choices"><button onclick="location.reload()">Restart</button></div>`);
  }
}

/* ---------- Simple audio toggle (works even if blocked) ---------- */
let ac, loopInterval=null;
function ensureAC(){ if(!ac){ ac=new (window.AudioContext||window.webkitAudioContext)(); } }
document.getElementById('audioBtn').onclick=()=>{
  state.audioOn=!state.audioOn;
  const b=document.getElementById('audioBtn');
  b.textContent = state.audioOn? "ðŸ”Š Audio" : "ðŸ”ˆ Audio";
  if(state.audioOn){ ensureAC(); if(!loopInterval){ loopInterval=setInterval(()=>{},1000);} }
  else{ if(loopInterval){ clearInterval(loopInterval); loopInterval=null; } }
};
</script>
</body>
</html>
